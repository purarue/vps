#!/usr/bin/env bash

set -eu
set -o pipefail

wait-for-internet --quiet --timeout 10 || exit $?

cmd_with_retry() {
	local count=1
	# shellcheck disable=SC2029
	while ! "$@"; do
		printf "Retrying (%d)...\n" "$count"
		sleep 1
		((count++))
		if ((count > 10)); then
			return 1
		fi
	done
}

SYNC_FROM_TTALLY="$TTALLY_DATA_DIR"
SYNC_TO_TTALLY=vultr:'~/.ttally_sync/ttally'

SYNC_FROM_REMINDER_SILENT="$HPIDATA/reminder-sink-silent.txt"
SYNC_TO_REMINDER_SILENT=vultr:'~/.ttally_sync/silent.txt'

declare -a rsync_flags=(--archive --verbose --compress --update -e ssh)

cmd_with_retry rsync "${rsync_flags[@]}" "$SYNC_FROM_TTALLY" "$SYNC_TO_TTALLY" || exit $?
cmd_with_retry rsync "${rsync_flags[@]}" "$SYNC_FROM_REMINDER_SILENT" "$SYNC_TO_REMINDER_SILENT"
