#!/usr/bin/env bash

set -eu
set -o pipefail

wait-for-internet --quiet --timeout 10 || exit $?

cmd_with_retry() {
	local count=1
	# shellcheck disable=SC2029
	while ! "$@"; do
		printf "Retrying (%d)...\n" "$count"
		sleep 1
		((count++))
		if ((count > 10)); then
			return 1
		fi
	done
}

declare -a rsync_flags=(--archive --verbose --compress --update -e ssh)

run_sync() {
	cmd_with_retry rsync "${rsync_flags[@]}" "$@" || exit $?
}

run_sync "$TTALLY_DATA_DIR" vultr:'~/.ttally_sync/ttally'
run_sync "$HPIDATA/reminder-sink-silent.txt" vultr:'~/.ttally_sync/silent.txt'
run_sync "$HPIDATA/.self_types.txt" vultr:'~/.ttally_sync/.self_types.txt'
